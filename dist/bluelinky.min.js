/**
 * bluelinky (https://github.com/hacksore/bluelinky)
 *
 * MIT License
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("got"),require("form-data")):"function"==typeof define&&define.amd?define(["got","form-data"],t):(e=e||self).bluelinky=t(e.got,e.FormData)}(this,function(o,s){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o,s=s&&s.hasOwnProperty("default")?s.default:s;var e,r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};function t(i,o,u,a){return new(u=u||Promise)(function(e,t){function n(e){try{s(a.next(e))}catch(e){t(e)}}function r(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,r)}s((a=a.apply(i,o||[])).next())})}function u(n,r){var s,i,o,e,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(s)throw new TypeError("Generator is already executing.");for(;u;)try{if(s=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,i=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(n,u)}catch(e){t=[6,e],i=0}finally{s=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function a(){}function n(){n.init.call(this)}function c(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function i(e,t,n,r){var s,i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),o=i[t]):(i=e._events=new a,e._eventsCount=0),o){if("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(s=c(e))&&0<s&&o.length>s){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,function(e){"function"==typeof console.warn?console.warn(e):console.log(e)}(u)}}else o=i[t]=n,++e._eventsCount;return e}function h(e,t,n){var r=!1;function s(){e.removeListener(t,s),r||(r=!0,n.apply(e,arguments))}return s.listener=n,s}function l(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function v(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}a.prototype=Object.create(null),(n.EventEmitter=n).usingDomains=!1,n.prototype.domain=void 0,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.init=function(){this.domain=null,n.usingDomains&&e.active&&e.Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new a,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return c(this)},n.prototype.emit=function(e,t,n,r){var s,i,o,u,a,c,h,l="error"===e;if(c=this._events)l=l&&null==c.error;else if(!l)return!1;if(h=this.domain,l){if(s=t,h)return(s=s||new Error('Uncaught, unspecified "error" event')).domainEmitter=this,s.domain=h,s.domainThrown=!1,h.emit("error",s),!1;if(s instanceof Error)throw s;var f=new Error('Uncaught, unspecified "error" event. ('+s+")");throw f.context=s,f}if(!(i=c[e]))return!1;var p="function"==typeof i;switch(o=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var r=e.length,s=v(e,r),i=0;i<r;++i)s[i].call(n)}(i,p,this);break;case 2:!function(e,t,n,r){if(t)e.call(n,r);else for(var s=e.length,i=v(e,s),o=0;o<s;++o)i[o].call(n,r)}(i,p,this,t);break;case 3:!function(e,t,n,r,s){if(t)e.call(n,r,s);else for(var i=e.length,o=v(e,i),u=0;u<i;++u)o[u].call(n,r,s)}(i,p,this,t,n);break;case 4:!function(e,t,n,r,s,i){if(t)e.call(n,r,s,i);else for(var o=e.length,u=v(e,o),a=0;a<o;++a)u[a].call(n,r,s,i)}(i,p,this,t,n,r);break;default:for(u=new Array(o-1),a=1;a<o;a++)u[a-1]=arguments[a];!function(e,t,n,r){if(t)e.apply(n,r);else for(var s=e.length,i=v(e,s),o=0;o<s;++o)i[o].apply(n,r)}(i,p,this,u)}return!0},n.prototype.on=n.prototype.addListener=function(e,t){return i(this,e,t,!1)},n.prototype.prependListener=function(e,t){return i(this,e,t,!0)},n.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,h(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,h(this,e,t)),this},n.prototype.removeListener=function(e,t){var n,r,s,i,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new a:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,i=n.length;0<i--;)if(n[i]===t||n[i].listener&&n[i].listener===t){o=n[i].listener,s=i;break}if(s<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new a,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,s=e.length;r<s;n+=1,r+=1)e[n]=e[r];e.pop()}(n,s);r.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new a,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new a:delete n[e]),this;if(0===arguments.length){for(var r,s=Object.keys(n),i=0;i<s.length;++i)"removeListener"!==(r=s[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new a,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(;this.removeListener(e,t[t.length-1]),t[0];);return this},n.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):l.call(e,t)},n.prototype.listenerCount=l,n.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};var f="https://owners.hyundaiusa.com/etc/designs/ownercommon/us/token.json?reg=",p="https://owners.hyundaiusa.com/libs/granite/csrf/token.json",d="https://owners.hyundaiusa.com/bin/common/connectCar",m="https://owners.hyundaiusa.com/bin/common/remoteAction",y="https://owners.hyundaiusa.com/bin/common/usagestats",_="https://owners.hyundaiusa.com/bin/common/VehicleHealthServlet",g="https://owners.hyundaiusa.com/bin/common/MessageCenterServlet",E="https://owners.hyundaiusa.com/bin/common/MyAccountServlet",w="https://owners.hyundaiusa.com/bin/common/enrollmentFeature",b="https://owners.hyundaiusa.com/bin/common/enrollmentStatus",S="https://owners.hyundaiusa.com/bin/common/managesubscription";function I(e){var t=new s;for(var n in e){var r=e[n];"object"!=typeof r&&t.append(n,r.toString())}return t}var L=(T.prototype.addFeature=function(e,t){this._currentFeatures[e]="ON"===t},T.prototype.onInit=function(){return t(this,void 0,void 0,function(){var t,n=this;return u(this,function(e){switch(e.label){case 0:return[4,this.features()];case 1:return"E:Failure"!==(t=e.sent()).result&&void 0===t.result||t.result.forEach(function(e){n.addFeature(e.featureName,e.featureStatus)}),this._eventEmitter.emit("ready"),[2]}})})},Object.defineProperty(T.prototype,"vin",{get:function(){return this._vin},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"eventEmitter",{get:function(){return this._eventEmitter},enumerable:!0,configurable:!0}),T.prototype.hasFeature=function(e){return this._currentFeatures[e]},T.prototype.getFeatures=function(){return this._currentFeatures},T.prototype.unlock=function(){return t(this,void 0,void 0,function(){var t,n;return u(this,function(e){switch(e.label){case 0:if(!this.hasFeature("DOOR UNLOCK"))throw new Error("Vehicle does not have the unlock feature");return t={gen:2,regId:this.vin,service:"remoteunlock"},[4,this._request(m,t)];case 1:return[2,{result:(n=e.sent()).RESPONSE_STRING,status:n.E_IFRESULT,errorMessage:n.E_IFFAILMSG}]}})})},T.prototype.lock=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:if(!this.hasFeature("DOOR LOCK"))throw new Error("Vehicle does not have the lock feature");return[4,this._request(m,{gen:2,regId:this.vin,service:"remotelock"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.start=function(n){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(m,r({gen:2,regId:this.vin,service:"ignitionstart"},n))];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.stop=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(m,{gen:2,regId:this.vin,service:"ignitionstop"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.flashLights=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(m,{gen:2,regId:this.vin,service:"light"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.panic=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(m,{gen:2,regId:this.vin,service:"horn"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.health=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(_,{service:"getRecMaintenanceTimeline"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.apiUsageStatus=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(y,{startdate:20140401,enddate:20190611,service:"getUsageStats"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING.OUT_DATA,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.messages=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(g,{service:"messagecenterservices"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING.results,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.accountInfo=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(E,{service:"getOwnerInfoDashboard"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.features=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(b,{service:"getEnrollment"})];case 1:return[2,{result:(t=e.sent()).FEATURE_DETAILS.featureDetails,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.serviceInfo=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(E,{service:"getOwnersVehiclesInfoService"})];case 1:return[2,{result:(t=e.sent()).OwnerInfo,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.pinStatus=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(E,{service:"getpinstatus"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.subscriptionStatus=function(){return t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(S,{service:"getproductCatalogDetails"})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING.OUT_DATA.PRODUCTCATALOG,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype.status=function(n){return void 0===n&&(n=!1),t(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._request(w,{services:"getVehicleStatus",gen:2,regId:this.vin,refresh:n})];case 1:return[2,{result:(t=e.sent()).RESPONSE_STRING.vehicleStatus,status:t.E_IFRESULT,errorMessage:t.E_IFFAILMSG}]}})})},T.prototype._request=function(s,i){return t(this,void 0,void 0,function(){var t,n,r;return u(this,function(e){switch(e.label){case 0:return[4,this._bluelinky.handleTokenRefresh()];case 1:return e.sent(),t=Object.assign({vin:this.vin,username:this._bluelinky.username,pin:this._pin,url:"https://owners.hyundaiusa.com/us/en/page/dashboard.html",token:this._bluelinky.accessToken},i),n=I(t),[4,o(s,{method:"POST",body:n})];case 2:r=e.sent();try{return[2,JSON.parse(r.body)]}catch(e){return[2,null]}return[2]}})})},T);function T(e){this._currentFeatures={},this._vin=e.vin,this._pin=e.pin,this._eventEmitter=new n,this._bluelinky=e.bluelinky,this.onInit()}function F(e){this.authConfig={username:null,password:null},this._accessToken=null,this._tokenExpires=null,this._vehicles=[],this.authConfig=e}return F.prototype.login=function(){return t(this,void 0,void 0,function(){var t,n;return u(this,function(e){switch(e.label){case 0:return[4,this.getToken()];case 1:return t=e.sent(),n=Math.floor(+new Date/1e3+parseInt(t.expires_in,10)),this.accessToken=t.access_token,this.tokenExpires=n,[2]}})})},Object.defineProperty(F.prototype,"accessToken",{get:function(){return this._accessToken},set:function(e){this._accessToken=e},enumerable:!0,configurable:!0}),Object.defineProperty(F.prototype,"tokenExpires",{get:function(){return this._tokenExpires||0},set:function(e){this._tokenExpires=e},enumerable:!0,configurable:!0}),Object.defineProperty(F.prototype,"username",{get:function(){return this.authConfig.username},enumerable:!0,configurable:!0}),F.prototype.getVehicles=function(){return this._vehicles},F.prototype.getVehicle=function(t){return this._vehicles.find(function(e){return t===e.vin})},F.prototype.registerVehicle=function(e,t){if(this.getVehicle(e))return Promise.resolve(null);var n=new L({vin:e,pin:t,token:this.accessToken,bluelinky:this});return this._vehicles.push(n),new Promise(function(e,t){n.eventEmitter.on("ready",function(){return e(n)})})},F.prototype.handleTokenRefresh=function(){return t(this,void 0,void 0,function(){return u(this,function(e){switch(e.label){case 0:return Math.floor(+new Date/1e3)>=this.tokenExpires-60?(console.log("token is expired, refreshing access token"),[4,this.getToken()]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},F.prototype.getToken=function(){return t(this,void 0,void 0,function(){var t,n,r,s;return u(this,function(e){switch(e.label){case 0:return n=Math.floor(+new Date/1e3),[4,o(f+n,{method:"GET",json:!0})];case 1:return t=e.sent(),r=t.body.token,[4,o(p,{method:"GET",headers:{Cookie:"csrf_token="+r+";"}})];case 2:return t=e.sent(),s=I({":cq_csrf_token":r,username:this.authConfig.username,password:this.authConfig.password,url:"https://owners.hyundaiusa.com/us/en/index.html"}),[4,o(d,{method:"POST",body:s})];case 3:return t=e.sent(),[2,JSON.parse(t.body).Token]}})})},F});
